;;;; Functions used in parsing the programming language
;;;; used for program checking.

(defpackage #:parser
  (:use #:common-lisp #:cl-ppcre #:sb-gray))
(in-package #:parser)

;;; ******************************************
;;; Constants
;;; ******************************************

(defconstant var-regex "[a-zA-Z](?:\\d|\\w)*")
(defconstant reserved-keywords "true|false|if|else|while|T|F")
(defconstant usage-message
  "usage: program-checker <precondition> <program> <postcondition> [<variants>]")
(defconstant error-message
  "The program is not valid. Please verify the syntax and try again.")
(defconstant inv-var-error "The numbers of invariants and variants don't match. Please ensure to input equal numbers of each.")
(defconstant math-operators '(#\+ #\- #\*))

;;; ******************************************
;;; Global Variables
;;; ******************************************

(defparameter *invariants* '())
(defparameter *variants* '())
(defparameter *partial-proofs* '())
(defparameter *total-proofs* '())

;;; ******************************************
;;; Data structures
;;; ******************************************

(defstruct command var expression)
(defstruct if-command boolean then-command-list else-command-list)
(defstruct while-command boolean command-list)

;;; ******************************************
;;; Helper functions
;;; ******************************************

;;; Helper function for checking if two chars
;;; are equal with the possibility of char1 or
;;; char2 being nil
(defun char-eq (char1 char2)
  (and  
   (not
    (or (null char1) (null char2)))
   (char= char1 char2)))

(defun match (regex input)
  (multiple-value-bind (start end)
      (scan regex input)
    (if (or (null start) (null end))
	nil
	(and
	 (= 0 start)
	 (= (length input) end)))))

(defun read-while (stream regex)
  (format nil "狺祜镳骘汨狎疱咫汨狎铋篝蝈犴铋飑麒殪磲翥蝈珏ㄦ矧磲铋幄汨狎┅麒殪铒铛祆汨狎┅滹蝈徜汨狎篝蝈犴铋飑泔祆邈汨狎┅换嗅蝮弩犷轭翦珏骝镯篝蝈犴ㄤ彐躅疳蝮瀛轭篝蝈犴戾è汨狎蝈徜麒殪篝蝈犴③苘洵茛┅ㄩ磲翥寇茕汨狎螬汨狎螬┅换嗅蝮弩鲠蜷徕戾殇孱糸骈弪骝镯篝蝈犴ㄤ彐躅疳蝮瀛鲠篝蝈犴戾è汨狎蝈徜麒殪篝蝈犴③苘鬈茕茛┅ㄩㄡ钿磲翥鲠颦蝈珏汨狎螬铒磲翥蝈箦蝣邃脲黠蜾汨狎螬┅汨狎螬┅换嗅蝮弩戾骠沲蜢怛徙骝镯翳篝蝈犴ㄤ彐躅疳蝮瀛戾骠怛徙篝蝈犴磲翥④荏苘螵蝈徜麒殪篝蝈犴③苘筝┅换嗅蝮弩蜷玷沲蜢怛徙骝镯翳篝蝈犴ㄤ彐躅疳蝮瀛蜷玷舡怛徙篝蝈犴ㄡ钿蝈徜麒殪篝蝈犴④荏ㄣ栳颦羼蝈徜汨狎篝蝈犴铋飑＼蝈徜麒殪篝蝈犴④荏┅换换砒痱弩箝镱疳蝮轭骢钽糸镱换换嗅蝮弩翳镳弪狒矧犷翳箦泔钿镳弪犷换镦磲翳屙狒殂犰屮痱弩箝镱骝镯篝蝈犴ㄤ彐躅疳蝮瀛磲翳屮痱弩箝镱篝蝈犴戾è汨狎蝈徜汨狎篝蝈犴铋飑蝈篚祠┅ㄩㄡ钿礤礅弪汨狎磲翳镳弪狒矧螬蝈徜麒殪篝蝈犴④荏箦翩蝈篚祠疳蝮瀛屮痱弩箝镱篝蝈犴┅ㄦ矧磲铋狺幄汨狎蝈篚祠┅┅ㄤ彐躅疳蝮瀛泔眇戾屮痱弩箝镱篝蝈犴换俞鲥翳沲蝌孱痫箝糸镱镦翳篝蝈犴戾è篝蝈犴痫篝蝈犴骈戾痫箝糸镱篝蝈犴┅ㄥ痱蝈篚祠磲翳蝈篚祠┅ㄩㄡ钿箦翩屮痱蝈篚祠疳蝮瀛屮痱弩箝镱篝蝈犴┅蝈徜麒殪篝蝈犴④荏箦翩磲翳蝈篚祠疳蝮瀛磲翳屮痱弩箝镱篝蝈犴┅ㄦ矧磲铋狺幄屮痱蝈篚祠磲翳蝈篚祠痱镧换义篝矧翳篝蝈犴麸轸矧殓轭犰痫箝糸镱篝蝈犴骈戾痫箝糸镱篝蝈犴篝蝈犴痫螬ㄩㄡ钿ㄣ栳颦羼蝈徜汨狎篝蝈犴铋飑＼箦翩屮痱蝈篚祠疳蝮瀛屮痱弩箝镱篝蝈犴┅ㄦ矧磲铋幄屮痱蝈篚祠┅┅┅ㄤ彐躅疳蝮瀛疳蝈铘桢箝邃屮痱弩箝镱篝蝈犴戾è蝈篚祠┅ㄩㄡ钿ㄣ栳颦羼蝈徜汨狎篝蝈犴铋飑＼ī蝈徜麒殪篝蝈犴④荏箦翩蝈篚祠疳蝮瀛泔眇戾屮痱弩箝镱篝蝈犴┅蝈徜麒殪篝蝈犴④荏ㄣ栳颦羼蝈徜汨狎篝蝈犴铋飑＼┅ㄦ矧磲铋岍蝈篚祠┅┅ㄤ彐躅疳蝮瀛屮痱弩箝镱篝蝈犴戾è汨狎ㄦ矧磲铋幄疱咫汨狎铋篝蝈犴铋飑┅ㄣ镱è磲翥③苘洵茛汨狎疳蝮瀛轭篝蝈犴┅è磲翥④荀汨狎疳蝮瀛鲠篝蝈犴┅è磲翥④塄汨狎疳蝮瀛疳蝈铘桢箝邃屮痱弩箝镱篝蝈犴┅┅换换嘛镬遽疳蝮轭骢钽糸镱换ㄤ彐躅疳蝮瀛泔眇秕钿怙镬遽篝蝈犴戾è汨狎蝈徜汨狎篝蝈犴铋飑┅ㄣ镱è汨狎羼汨狎＼Ι蝈徜麒殪篝蝈犴④荏ㄦ矧磲铋狺幄＼疳蝮瀛怙镬遽篝蝈犴┅è犷ㄣ栳颦羼汨狎＼ㄣ栳颦羼蝈徜汨狎篝蝈犴铋飑＼┅蝈徜麒殪篝蝈犴④荏ㄦ矧磲铋岑幄＼疳蝮瀛怙镬遽篝蝈犴┅┅┅ㄤ彐躅疳蝮瀛泔眇戾怙镬遽篝蝈犴戾è汨狎疱咫汨狎铋篝蝈犴铋飑┅ㄩㄣ栳颦羼汨狎＼々痱镧蝈徜汨狎篝蝈犴铋飑ㄦ矧磲铋狺幄＼疳蝮瀛怙镬遽篝蝈犴┅换俞鲥翳痫箝糸镱镦翳篝蝈犴骘祜镫徼遽戾è篝蝈犴痫篝蝈犴骈戾痫箝糸镱篝蝈犴┅镳汨狎铋飑蝈篚祠┅ㄩ箦翩蝈篚祠疳蝮瀛屮痱弩箝镱篝蝈犴┅痱镧蝈徜麒殪篝蝈犴④荏箦翩镳汨狎蝈徜汨狎篝蝈犴铋飑ㄩㄡ钿矧ㄣ栳颦羼镳汨狎＼缉ㄣ栳颦羼镳汨狎＼京铒ㄣ栳颦羼疱咫汨狎铋篝蝈犴铋飑＼僵┅痱镧蝈徜麒殪篝蝈犴④荏ㄦ矧磲铋狺狺幄蝈篚祠镳汨狎疳蝮瀛屮痱弩箝镱篝蝈犴┅戾è铄舡汨狎蝈徜汨狎篝蝈犴铋飑┅蝈徜麒殪篝蝈犴④荏ㄣ镱è犷ㄣ栳颦羼镳汨狎＼缉ㄣ栳颦羼铄舡汨狎＼僵ㄦ矧磲铋峒浸幄蝈篚祠疳蝮瀛屮痱弩箝镱篝蝈犴┅è犷ㄣ栳颦羼镳汨狎＼京ㄣ栳颦羼铄舡汨狎＼僵ㄦ矧磲铋峋浸幄蝈篚祠疳蝮瀛屮痱弩箝镱篝蝈犴┅è犷ㄣ栳颦羼镳汨狎＼々ㄣ栳颦羼铄舡汨狎＼僵ㄦ矧磲铋帷浸幄蝈篚祠疳蝮瀛屮痱弩箝镱篝蝈犴┅è犷ㄣ栳颦羼镳汨狎＼僵ㄣ栳颦羼铄舡汨狎＼僵ㄦ矧磲铋峤幄蝈篚祠疳蝮瀛屮痱弩箝镱篝蝈犴┅┅┅痱镧换义篝矧翳篝蝈犴狒轸矧殓轭犰痫箝糸镱篝蝈犴骈戾痫箝糸镱篝蝈犴篝蝈犴痫螬ㄩㄡ钿箦翩蝈篚祠疳蝮瀛怙镬遽篝蝈犴┅蝈徜麒殪篝蝈犴④荏┅ㄦ矧磲铋狺幄蝈篚祠疳蝮瀛泔眇秕钿怙镬遽篝蝈犴┅┅┅┅ㄤ彐躅疳蝮瀛怙镬遽篝蝈犴ㄩㄣ栳颦羼疱咫汨狎铋篝蝈犴铋飑＼ī戾è蝈篚祠┅ㄩㄡ钿ㄣ栳颦羼蝈徜汨狎篝蝈犴铋飑＼ī蝈徜麒殪篝蝈犴④荏箦翩蝈篚祠疳蝮瀛泔眇戾怙镬遽篝蝈犴┅蝈徜麒殪篝蝈犴④荏ㄣ栳颦羼蝈徜汨狎篝蝈犴铋飑＼┅ㄦ矧磲铋岍蝈篚祠┅戾è鲠祯蝈徜麒殪篝蝈犴③趄蹂驷祗茛┅ㄣ镱è磲翥Ⅳ蝓澧鲠祯濠⒃è磲翥㈡犰箦鲠祯濠⑵┅┅换换蔑眄犷疳蝮轭骢钽糸镱换ㄤ彐躅疳蝮瀛狍箝珙礤铘篝蝈犴戾è泔眄磲脲泔眄犷洎┅ㄩㄡ钿箦翩ㄣ镯磲钿鲠泔眄疳蝮瀛鲠篝蝈犴┅蝈徜麒殪篝蝈犴④荏ㄣ栳颦羼蝈徜汨狎篝蝈犴铋飑＼僵蝈徜麒殪篝蝈犴④荏箦翩ㄣ镯磲钿屮痱弩箝镱泔眄疳蝮瀛屮痱弩箝镱篝蝈犴┅泔眄┅ㄤ彐躅疳蝮瀛殒篝蝈犴戾è汨狎痱镧ㄦ矧磲铋狺幄蝈徜汨狎篝蝈犴铋飑蝈徜汨狎篝蝈犴铋飑┅ㄣ镯磲脲殒泔眄犷洎┅ㄩㄡ钿磲翥㈤姊汨狎螬蝈徜麒殪篝蝈犴④荏箦翩ㄩ姝泔眄犷洵怙镬遽泔眄疳蝮瀛怙镬遽篝蝈犴┅疳蝮瀛戾骠怛徙篝蝈犴箦翩ㄩ姝泔眄犷洵翳孱泔眄犷洵扉篝泔眄疳蝮瀛泔眄犷洵扉篝篝蝈犴┅疳蝮瀛蜷玷舡怛徙篝蝈犴磲翥㈠祗澧蝈徜麒殪篝蝈犴③屐箦茛┅疳蝮瀛戾骠怛徙篝蝈犴箦翩ㄩ姝泔眄犷洵屐箦泔眄犷洵扉篝泔眄疳蝮瀛泔眄犷洵扉篝篝蝈犴┅疳蝮瀛蜷玷舡怛徙篝蝈犴┅泔眄┅ㄤ彐躅疳蝮瀛麒殪篝蝈犴戾è汨狎蝈徜麒殪篝蝈犴③麒殪遢┅ㄣ镯磲脲麒殪瀛泔眄犷洎┅ㄩㄡ钿磲翥Ⅶ栝戾汨狎螬蝈徜麒殪篝蝈犴④荏箦翩麒殪瀛泔眄犷洵怙镬遽泔眄疳蝮瀛怙镬遽篝蝈犴┅疳蝮瀛戾骠怛徙篝蝈犴箦翩麒殪瀛泔眄犷洵泔眄犷洵扉篝泔眄疳蝮瀛泔眄犷洵扉篝篝蝈犴┅疳蝮瀛蜷玷舡怛徙篝蝈犴┅泔眄┅ㄤ彐躅疳蝮瀛泔眄犷篝蝈犴换义徜翳骈蝮驽汨狎徙翦蝮犷翳孱蝈箦翳篝蝈犴换麸腩秣栾麸疳蝮翳泔眄犷潴戾è篝蝈犴痫篝蝈犴骈戾痫箝糸镱篝蝈犴┅ㄣ栳蝮蝈徜麒殪篝蝈犴③苘鬈茕茛┅篝蝈犴骈戾痫箝糸镱篝蝈犴篝蝈犴痫螬ㄣ镱è磲翥㈤姊汨狎螬疳蝮瀛殒篝蝈犴┅è磲翥Ⅶ栝戾汨狎螬疳蝮瀛麒殪篝蝈犴┅疳蝮瀛狍箝珙礤铘篝蝈犴┅┅ㄤ彐躅疳蝮瀛泔眄犷洵扉篝篝蝈犴祜镳骘泔眄疳蝮瀛泔眄犷篝蝈犴骘汨狎痱镧蝈徜麒殪篝蝈犴④荏疱咫汨狎铋篝蝈犴铋飑骘轶箦黹泔祜ㄣ栳颦羼汨狎＼哗骘轶泔眄犷ㄣ镯磲钿泔眄骘泔铘轭蹂麒殪铒铛祆泔眄┅泔祆邈泔眄滹ㄩ轶泔眄犷ㄩ轶箦黹泔祜蝈徜汨狎篝蝈犴铋飑箦翩泔铘轭蹂铋飑┅滹蝈徜麒殪篝蝈犴④荏麒殪泔铘轭蹂┅换换蔑眄犷怩忖扉铉骢钽糸镱换ㄤ彐躅怩忖戾狍箝珙礤铘ㄣ镯磲钿痱镳泔钿蝈珏蝈痨徙瀛犰ㄣ镱汜翦钺翦篝蜷铉ㄛ捃荀蔹圮荏荸ㄣ镯磲钿鲠泔眄犷洎ㄛ捃荀蔹圮荏荸痱镳泔钿ㄣ镱汜翦钺翦篝蜷铉④茺饼ㄣ镯磲钿屮痱弩箝镱泔眄犷洎④茺昌┅ㄤ彐躅怩忖戾殒ㄣ镯磲钿痱镳泔钿戾è岜ㄢ踱忪瀛泔眄犷潴ㄩ姝泔眄犷洵翳孱泔眄犷洵扉篝泔眄犷洎痱镳泔钿┅ㄡㄢ踱忪瀛泔眄犷潴ㄩ姝泔眄犷洵屐箦泔眄犷洵扉篝泔眄犷洎痱镳泔钿┅ㄢ镲ㄩ姝泔眄犷洵怙镬遽泔眄犷洎┅ㄦ矧磲铋岘峻岍屺狺岘峻岍怙镬岜＼＼怙镬岵┅ㄤ彐躅怩忖戾疳螋獒飙麒殪ㄣ镯磲钿痱镳泔钿戾è轭鲠蜷犷痫轭鲠蜷犷趔┅ㄩ铛祆轭鲠蜷犷舂箦翩轭鲠蜷犷㈤铞┅戾è轫痨殄ㄢ踱忪瀛泔眄犷潴麒殪瀛泔眄犷洵泔眄犷洵扉篝泔眄犷洎轭鲠蜷犷舂ㄢ镲麒殪瀛泔眄犷洵怙镬遽泔眄犷洎┅瘐箬ㄦ矧磲铋岑狺狺岍鲸岍轭鲠蜷犷＼＼怙镬痱镳泔钿疳螋獒飙痱镲骟瘐箬ㄦ矧磲铋岑狺岍鲸岍轭鲠蜷犷＼怙镬轫痨殄洎疳螋獒飙痱镲骟轭鲠蜷犷舂┅ㄤ彐躅怩忖戾麸翎飙麒殪ㄣ镯磲钿痱镳泔钿戾è轭鲠蜷犷痫轭鲠蜷犷趔┅鲠蜷犷痫鲠蜷犷趔┅ㄩ铛祆轭鲠蜷犷舂箦翩轭鲠蜷犷㈤铞┅ㄩ铛祆鲠蜷犷舂箦翩鲠蜷犷Ⅵ狎┅戾è轫痨殄ㄢ踱忪瀛泔眄犷潴麒殪瀛泔眄犷洵泔眄犷洵扉篝泔眄犷洎ㄦ矧磲铋岑岚冀峒轭轸轭鲠蜷犷＼鲠蜷犷舂┅ㄢ镲麒殪瀛泔眄犷洵怙镬遽泔眄犷洎┅瘐箬ㄦ矧磲铋岑狺狺岍鲸岍轭鲠蜷犷＼＼怙镬痱镳泔钿麸翎飙痱镲骟瘐箬ㄦ矧磲铋岑狺岑岚冀峤轭轸┉鲸岍轭鲠蜷犷＼怙镬＼鲠蜷犷轫痨殄洎麸翎飙痱镲骟ㄦ矧磲铋岑岚冀幄轭鲠蜷犷＼鲠蜷犷舂┅ㄤ彐躅怩忖戾泔眄犷潴ㄣ镯磲钿痫篝泔钿轸轱镳糸镱犰麸翎飙泔蝌邈纛弩铋飑ㄩ铛祆泔眄犷潴铋戾è蝈鲥蝮瀛泔眄犷潴蝈鲥蝮泔眄犷潴┅ㄣ躜蝈铘痱镳泔钿轸轱痫篝泔钿轸轱瞟祜镳骘泔眄犷轭蝈鲥蝮瀛泔眄犷潴殒ㄣ镯磲钿泔眄犷洎滹箦翩沲蝌孱舡痱镳泔钿轸轱ㄢ踱忪瀛狍箝珙礤铘泔眄犷沲蝌孱舡痱镳泔钿轸轱瞟殒ㄩ姝泔眄犷洵泔眄犷洎滹箦翩沲蝌孱舡痱镳泔钿轸轱ㄢ踱忪瀛殒泔眄犷沲蝌孱舡痱镳泔钿轸轱瞟殒麒殪瀛泔眄犷洵泔眄犷洎滹痱镧箦翩沲蝌孱舡痱镳泔钿轸轱ㄩ铛祆麸翎飙泔蝌邈纛弩螬ㄢ踱忪瀛疳螋獒飙麒殪泔眄犷沲蝌孱舡痱镳泔钿轸轱瞟ㄢ踱忪瀛麸翎飙麒殪泔眄犷沲蝌孱舡痱镳泔钿轸轱瞟┅┅沲蝌孱舡痱镳泔钿轸轱瞟┅换换歪轭骢钽糸镱换ㄤ彐躅怩殪洵疳蝮瀛趄邋ㄩ铕豸戾舄è篝蝈犴磲脲篝蜷铉轭瘐舡篝蝈犴轭瘐舂┅蝈徜麒殪篝蝈犴④荏戾è泔眄扉篝疳蝮瀛泔眄犷洵扉篝篝蝈犴┅ㄩㄡ钿铒铛祆泔眄扉篝┅铛祆蝈徜汨狎篝蝈犴铋飑┅泔眄扉篝┅┅ㄤ彐躅汨邈氕痱镧蜥痱邈镱溟糸镱痱镧蜥痫篝泔钿轸轱轭鲠蜷犷趔鲠蜷犷趔箦翩疳螋獒飙痱镲骟Ж┅箦翩麸翎飙痱镲骟Ж┅箦翩轭鲠蜷犷趔蝈鲥蝮轭鲠蜷犷趔┅箦翩鲠蜷犷趔蝈鲥蝮鲠蜷犷趔┅戾舄è疳蝮瀛趄邋ㄢ蹰熹疳蝮瀛趄邋痱镧蜥愆ㄩ铞狎獒铘蟓泔瘗ㄣ镳扉篝轭鲠蜷犷趔┅疳螋獒飙泔蝌邈纛弩ㄢ踱忪瀛泔眄犷潴疳蝮瀛趄邋ㄦ矧磲铋岍痫篝泔钿轸轱瞟┅箦翩轭鲠蜷犷趔ㄣ镳扉篝轭鲠蜷犷趔泔瘗┅戾è麸翎飙泔蝌邈纛弩ㄢ踱忪瀛泔眄犷潴疳蝮瀛趄邋ㄦ矧磲铋岍痫篝泔钿轸轱瞟舂┅ㄩ矧铛祆疳螋獒飙泔蝌邈纛弩螬铛祆麸翎飙泔蝌邈纛弩螬铋ㄦ矧磲铋⑿狎糸犰泔蝌邈纛弩痱镲骟湖エ岍狺狺ピ雉犰泔蝌邈纛弩痱镲骟湖エ岍狺狺痱邈镱溟糸镱疳螋獒飙泔蝌邈纛弩疳螋獒飙痱镲骟痱邈镱溟糸镱麸翎飙泔蝌邈纛弩麸翎飙痱镲骟┅┅ㄤ彐躅磲轭ㄡ蜱雯ㄩ铒窘戾铉翳狎琏穿痱镧黩轸瀛扉铄躞徵瀛礤篌徵濠筲屮艉屮轸┅戾è痱邈镱溟糸镱铘狎琏┅痱镧蜥铘狎琏┅痫篝泔钿轸轱铘狎琏┅ㄩ铞鲠颦戾铉翳ō戾铉翳狎琏穿┅ㄩ铒盹轭霏鲠颦戾铉翳博癌黩轸瀛扉铄轭霏鲠颦弪蝻颟戾舄è轭霏戾铉翳ǒ轭霏鲠颦戾铉翳博ㄩ铞狎獒铘篚怏羼狎琏ǐ轭霏戾铉翳穿┅鲠蜷犷趔篚怏羼狎琏ǐ轭霏戾铉翳穿戾铉翳狎琏┅蝈篚祠ㄣ桢汶痱镧蜥痱邈镱溟糸镱痱镧蜥痫篝泔钿轸轱轭鲠蜷犷趔鲠蜷犷趔┅ㄩ铛祆蝈篚祠黩轸瀛扉铄弪蝻颦礤篌徵濠黩轸瀛扉铄蝈篚祠┅筲屮艉屮轸┅┅┅